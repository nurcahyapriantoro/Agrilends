<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrilends Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .admin-info h1 {
            color: #f7fafc;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .admin-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-online {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .status-maintenance {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .status-offline {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .system-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .overview-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .overview-value {
            font-size: 2rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 5px;
        }

        .overview-label {
            color: #a0aec0;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .overview-trend {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .trend-up {
            background: rgba(72, 187, 120, 0.2);
            color: #68d391;
        }

        .trend-down {
            background: rgba(229, 62, 62, 0.2);
            color: #fc8181;
        }

        .trend-stable {
            background: rgba(66, 153, 225, 0.2);
            color: #90cdf4;
        }

        .main-dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #e53e3e, #c53030);
            border-radius: 2px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #a0aec0;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 5px;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 600;
            color: #f7fafc;
        }

        .alert-severity {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .severity-critical {
            background: rgba(229, 62, 62, 0.2);
            color: #fc8181;
        }

        .severity-error {
            background: rgba(237, 137, 54, 0.2);
            color: #f6ad55;
        }

        .severity-warning {
            background: rgba(237, 137, 54, 0.2);
            color: #f6ad55;
        }

        .severity-info {
            background: rgba(66, 153, 225, 0.2);
            color: #90cdf4;
        }

        .alert-description {
            color: #cbd5e0;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .alert-time {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .user-analytics {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analytics-header {
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 15px;
        }

        .analytics-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .analytics-metric {
            text-align: center;
        }

        .analytics-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f7fafc;
        }

        .analytics-label {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(229, 62, 62, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .risk-dashboard {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .risk-score {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .risk-low {
            background: rgba(72, 187, 120, 0.2);
            color: #68d391;
        }

        .risk-medium {
            background: rgba(237, 137, 54, 0.2);
            color: #f6ad55;
        }

        .risk-high {
            background: rgba(229, 62, 62, 0.2);
            color: #fc8181;
        }

        .risk-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .risk-item {
            text-align: center;
            padding: 10px;
        }

        .risk-item-score {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f7fafc;
        }

        .risk-item-label {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 2px;
        }

        .operational-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .status-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .status-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #e53e3e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-dashboard {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .system-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="admin-info">
                    <h1>🛡️ Admin Dashboard</h1>
                    <div class="admin-badge">
                        <span id="admin-principal">Loading...</span>
                    </div>
                </div>
                <div class="system-status">
                    <div class="status-indicator status-online" id="system-status">
                        <span>🟢</span>
                        <span>System Online</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn" onclick="refreshDashboard()">🔄 Refresh</button>
                        <button class="btn btn-warning" onclick="openMaintenanceMode()">🔧 Maintenance</button>
                        <button class="btn btn-info" onclick="openAnalytics()">📊 Analytics</button>
                    </div>
                </div>
            </div>
            
            <div class="system-overview" id="system-overview">
                <div class="overview-card">
                    <div class="overview-value" id="total-users">0</div>
                    <div class="overview-label">Total Users</div>
                    <div class="overview-trend trend-up" id="users-trend">+0</div>
                </div>
                <div class="overview-card">
                    <div class="overview-value" id="active-loans">0</div>
                    <div class="overview-label">Active Loans</div>
                    <div class="overview-trend trend-stable" id="loans-trend">0</div>
                </div>
                <div class="overview-card">
                    <div class="overview-value" id="total-liquidity">₿0.00</div>
                    <div class="overview-label">Total Liquidity</div>
                    <div class="overview-trend trend-up" id="liquidity-trend">+0%</div>
                </div>
                <div class="overview-card">
                    <div class="overview-value" id="system-health">100%</div>
                    <div class="overview-label">System Health</div>
                    <div class="overview-trend trend-stable" id="health-trend">Stable</div>
                </div>
            </div>
        </div>

        <!-- Financial Metrics -->
        <div class="stats-row">
            <div class="dashboard-section">
                <h2 class="section-title">Financial Overview</h2>
                <div class="metrics-grid" id="financial-metrics">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <h2 class="section-title">Risk Management</h2>
                <div class="risk-dashboard" id="risk-dashboard">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="main-dashboard">
            <!-- Left Column -->
            <div>
                <!-- Performance Trends -->
                <div class="dashboard-section">
                    <h2 class="section-title">Performance Trends</h2>
                    <div class="chart-container" id="performance-chart">
                        <p>📈 Performance trends chart would be displayed here</p>
                    </div>
                </div>

                <!-- Operational Metrics -->
                <div class="dashboard-section" style="margin-top: 30px;">
                    <h2 class="section-title">Operational Status</h2>
                    <div class="operational-status" id="operational-status">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- User Analytics -->
                <div class="dashboard-section" style="margin-top: 30px;">
                    <h2 class="section-title">User Analytics</h2>
                    <div class="user-analytics" id="user-analytics">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- System Alerts -->
                <div class="dashboard-section">
                    <h2 class="section-title">System Alerts</h2>
                    <div id="system-alerts">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Monitoring -->
                <div class="dashboard-section" style="margin-top: 30px;">
                    <h2 class="section-title">Real-time Monitoring</h2>
                    <div id="realtime-metrics">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Actor, HttpAgent } from "https://cdn.skypack.dev/@dfinity/agent";
        import { Principal } from "https://cdn.skypack.dev/@dfinity/principal";

        // Canister configuration
        const canisterId = process.env.AGRILENDS_BACKEND_CANISTER_ID || "rrkah-fqaaa-aaaah-qcviq-cai";
        const host = process.env.DFX_NETWORK === "local" ? "http://localhost:8080" : "https://ic0.app";

        // Initialize agent and actor
        let agent;
        let actor;

        const initializeAgent = async () => {
            agent = new HttpAgent({ host });
            
            if (process.env.DFX_NETWORK === "local") {
                await agent.fetchRootKey();
            }

            actor = Actor.createActor(idlFactory, {
                agent,
                canisterId,
            });
        };

        // IDL factory for the admin dashboard functions
        const idlFactory = ({ IDL }) => {
            const User = IDL.Record({
                'id': IDL.Principal,
                'role': IDL.Variant({ 'Farmer': IDL.Null, 'Investor': IDL.Null }),
                'created_at': IDL.Nat64,
                'is_active': IDL.Bool,
            });

            const AlertSeverity = IDL.Variant({
                'Info': IDL.Null,
                'Warning': IDL.Null,
                'Error': IDL.Null,
                'Critical': IDL.Null,
            });

            const AdminDashboard = IDL.Record({
                'system_overview': IDL.Record({
                    'total_users': IDL.Nat64,
                    'active_loans': IDL.Nat64,
                    'total_liquidity': IDL.Nat64,
                    'total_collateral_value': IDL.Nat64,
                    'system_health_score': IDL.Nat64,
                    'uptime_percentage': IDL.Nat64,
                    'last_maintenance': IDL.Nat64,
                    'emergency_stop_active': IDL.Bool,
                }),
                'financial_metrics': IDL.Record({
                    'total_loans_issued': IDL.Nat64,
                    'total_amount_disbursed': IDL.Nat64,
                    'total_repaid': IDL.Nat64,
                    'outstanding_debt': IDL.Nat64,
                    'protocol_revenue': IDL.Nat64,
                    'default_rate': IDL.Nat64,
                    'average_loan_size': IDL.Nat64,
                    'pool_utilization': IDL.Nat64,
                }),
                'risk_management': IDL.Record({
                    'loans_at_risk': IDL.Nat64,
                    'overdue_loans': IDL.Nat64,
                    'liquidation_queue': IDL.Nat64,
                    'collateralization_ratio': IDL.Nat64,
                    'concentration_risk': IDL.Nat64,
                }),
                'operational_metrics': IDL.Record({
                    'total_transactions': IDL.Nat64,
                    'failed_transactions': IDL.Nat64,
                    'average_response_time': IDL.Nat64,
                    'oracle_uptime': IDL.Nat64,
                    'canister_cycles_remaining': IDL.Nat64,
                    'storage_utilization': IDL.Nat64,
                }),
                'user_analytics': IDL.Record({
                    'new_users_30d': IDL.Nat64,
                    'active_users_30d': IDL.Nat64,
                    'user_retention_rate': IDL.Nat64,
                    'average_session_duration': IDL.Nat64,
                    'user_satisfaction_score': IDL.Nat64,
                }),
                'recent_alerts': IDL.Vec(IDL.Record({
                    'alert_id': IDL.Nat64,
                    'severity': AlertSeverity,
                    'title': IDL.Text,
                    'description': IDL.Text,
                    'timestamp': IDL.Nat64,
                    'is_acknowledged': IDL.Bool,
                    'affected_component': IDL.Text,
                    'recommended_action': IDL.Text,
                })),
            });

            return IDL.Service({
                'get_admin_dashboard': IDL.Func([], [IDL.Variant({ 'Ok': AdminDashboard, 'Err': IDL.Text })], ['query']),
                'get_real_time_metrics': IDL.Func([], [IDL.Variant({ 'Ok': IDL.Record({}), 'Err': IDL.Text })], ['query']),
            });
        };

        // Admin Dashboard Manager Class
        class AdminDashboardManager {
            constructor() {
                this.dashboardData = null;
                this.realtimeMetrics = null;
                this.isLoading = false;
                this.refreshInterval = null;
            }

            async init() {
                try {
                    await initializeAgent();
                    await this.loadDashboard();
                    this.startRealtimeUpdates();
                    console.log('✅ Admin dashboard initialized successfully');
                } catch (error) {
                    console.error('❌ Failed to initialize admin dashboard:', error);
                    this.showError('Failed to initialize admin dashboard');
                }
            }

            async loadDashboard() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                try {
                    console.log('📊 Loading admin dashboard...');
                    const result = await actor.get_admin_dashboard();
                    
                    if ('Ok' in result) {
                        this.dashboardData = result.Ok;
                        this.renderDashboard();
                        console.log('✅ Admin dashboard loaded successfully');
                    } else {
                        throw new Error(result.Err);
                    }
                } catch (error) {
                    console.error('❌ Failed to load admin dashboard:', error);
                    this.showError('Failed to load dashboard data');
                } finally {
                    this.isLoading = false;
                }
            }

            async loadRealtimeMetrics() {
                try {
                    const result = await actor.get_real_time_metrics();
                    if ('Ok' in result) {
                        this.realtimeMetrics = result.Ok;
                        this.updateRealtimeDisplay();
                    }
                } catch (error) {
                    console.error('❌ Failed to load realtime metrics:', error);
                }
            }

            startRealtimeUpdates() {
                // Update realtime metrics every 30 seconds
                this.refreshInterval = setInterval(() => {
                    this.loadRealtimeMetrics();
                }, 30000);
            }

            renderDashboard() {
                if (!this.dashboardData) return;

                this.renderSystemOverview();
                this.renderFinancialMetrics();
                this.renderRiskDashboard();
                this.renderOperationalStatus();
                this.renderUserAnalytics();
                this.renderSystemAlerts();
            }

            renderSystemOverview() {
                const overview = this.dashboardData.system_overview;
                
                document.getElementById('total-users').textContent = overview.total_users.toString();
                document.getElementById('active-loans').textContent = overview.active_loans.toString();
                document.getElementById('total-liquidity').textContent = this.formatBTC(overview.total_liquidity);
                document.getElementById('system-health').textContent = `${overview.system_health_score}%`;

                // Update system status
                const statusElement = document.getElementById('system-status');
                if (overview.emergency_stop_active) {
                    statusElement.className = 'status-indicator status-offline';
                    statusElement.innerHTML = '<span>🔴</span><span>Emergency Stop</span>';
                } else if (overview.system_health_score < 80) {
                    statusElement.className = 'status-indicator status-maintenance';
                    statusElement.innerHTML = '<span>🟡</span><span>Degraded</span>';
                } else {
                    statusElement.className = 'status-indicator status-online';
                    statusElement.innerHTML = '<span>🟢</span><span>System Online</span>';
                }
            }

            renderFinancialMetrics() {
                const container = document.getElementById('financial-metrics');
                const financial = this.dashboardData.financial_metrics;

                const metricsHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${financial.total_loans_issued}</div>
                        <div class="metric-label">Total Loans Issued</div>
                        <div class="metric-change trend-up">+${financial.total_loans_issued}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatBTC(financial.total_amount_disbursed)}</div>
                        <div class="metric-label">Total Disbursed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatBTC(financial.total_repaid)}</div>
                        <div class="metric-label">Total Repaid</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatBTC(financial.outstanding_debt)}</div>
                        <div class="metric-label">Outstanding Debt</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatBTC(financial.protocol_revenue)}</div>
                        <div class="metric-label">Protocol Revenue</div>
                        <div class="metric-change trend-up">+revenue</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatPercentage(financial.default_rate)}</div>
                        <div class="metric-label">Default Rate</div>
                        <div class="metric-change ${financial.default_rate > 500 ? 'trend-down' : 'trend-stable'}">
                            ${financial.default_rate > 500 ? 'High' : 'Normal'}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatBTC(financial.average_loan_size)}</div>
                        <div class="metric-label">Avg Loan Size</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${this.formatPercentage(financial.pool_utilization)}</div>
                        <div class="metric-label">Pool Utilization</div>
                        <div class="metric-change ${financial.pool_utilization > 8000 ? 'trend-up' : 'trend-stable'}">
                            ${financial.pool_utilization > 8000 ? 'High' : 'Normal'}
                        </div>
                    </div>
                `;

                container.innerHTML = metricsHTML;
            }

            renderRiskDashboard() {
                const container = document.getElementById('risk-dashboard');
                const risk = this.dashboardData.risk_management;

                // Calculate overall risk score
                const overallRisk = Math.max(risk.concentration_risk, 
                    (risk.loans_at_risk * 100) / Math.max(this.dashboardData.system_overview.active_loans, 1));
                
                const riskClass = this.getRiskClass(overallRisk);
                const riskLabel = this.getRiskLabel(overallRisk);

                const riskHTML = `
                    <div class="risk-header">
                        <span style="color: #f7fafc; font-weight: 700;">Overall Risk Assessment</span>
                        <div class="risk-score ${riskClass}">
                            ${riskLabel} (${Math.round(overallRisk)}/100)
                        </div>
                    </div>
                    <div class="risk-breakdown">
                        <div class="risk-item">
                            <div class="risk-item-score">${risk.loans_at_risk}</div>
                            <div class="risk-item-label">At Risk Loans</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-item-score">${risk.overdue_loans}</div>
                            <div class="risk-item-label">Overdue</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-item-score">${risk.liquidation_queue}</div>
                            <div class="risk-item-label">Liquidation Queue</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-item-score">${this.formatPercentage(risk.collateralization_ratio)}</div>
                            <div class="risk-item-label">Collateral Ratio</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-item-score">${risk.concentration_risk}/100</div>
                            <div class="risk-item-label">Concentration</div>
                        </div>
                    </div>
                `;

                container.innerHTML = riskHTML;
            }

            renderOperationalStatus() {
                const container = document.getElementById('operational-status');
                const operational = this.dashboardData.operational_metrics;

                const successRate = operational.total_transactions > 0 ? 
                    ((operational.total_transactions - operational.failed_transactions) / operational.total_transactions * 100) : 100;

                const statusHTML = `
                    <div class="status-item">
                        <div class="status-value">${operational.total_transactions}</div>
                        <div class="status-label">Total Transactions</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value">${successRate.toFixed(1)}%</div>
                        <div class="status-label">Success Rate</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value">${operational.average_response_time}ms</div>
                        <div class="status-label">Avg Response</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value">${this.formatPercentage(operational.oracle_uptime)}</div>
                        <div class="status-label">Oracle Uptime</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value">${this.formatCycles(operational.canister_cycles_remaining)}</div>
                        <div class="status-label">Cycles Remaining</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value">${this.formatPercentage(operational.storage_utilization)}</div>
                        <div class="status-label">Storage Used</div>
                    </div>
                `;

                container.innerHTML = statusHTML;
            }

            renderUserAnalytics() {
                const container = document.getElementById('user-analytics');
                const analytics = this.dashboardData.user_analytics;

                const analyticsHTML = `
                    <div class="analytics-header">User Engagement Metrics</div>
                    <div class="analytics-metrics">
                        <div class="analytics-metric">
                            <div class="analytics-value">${analytics.new_users_30d}</div>
                            <div class="analytics-label">New Users (30d)</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-value">${analytics.active_users_30d}</div>
                            <div class="analytics-label">Active Users (30d)</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-value">${this.formatPercentage(analytics.user_retention_rate)}</div>
                            <div class="analytics-label">Retention Rate</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-value">${analytics.average_session_duration}m</div>
                            <div class="analytics-label">Avg Session</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-value">${analytics.user_satisfaction_score}/100</div>
                            <div class="analytics-label">Satisfaction</div>
                        </div>
                    </div>
                `;

                container.innerHTML = analyticsHTML;
            }

            renderSystemAlerts() {
                const container = document.getElementById('system-alerts');
                const alerts = this.dashboardData.recent_alerts;

                if (alerts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 40px;">No active alerts</p>';
                    return;
                }

                const alertsHTML = alerts.map(alert => {
                    const severityClass = this.getSeverityClass(alert.severity);

                    return `
                        <div class="alert-item">
                            <div class="alert-header">
                                <div class="alert-title">${alert.title}</div>
                                <div class="alert-severity ${severityClass}">
                                    ${this.formatSeverity(alert.severity)}
                                </div>
                            </div>
                            <div class="alert-description">${alert.description}</div>
                            <div class="alert-time">
                                ${this.formatTimestamp(alert.timestamp)} • ${alert.affected_component}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = alertsHTML;
            }

            updateRealtimeDisplay() {
                if (!this.realtimeMetrics) return;

                const metricsContainer = document.getElementById('realtime-metrics');
                const metricsHTML = `
                    <div class="analytics-header">Real-time System Metrics</div>
                    <div class="analytics-metrics">
                        <div class="analytics-metric">
                            <div class="analytics-value">${this.realtimeMetrics.timestamp || 'N/A'}</div>
                            <div class="analytics-label">Last Update</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-value">${this.realtimeMetrics.system_health || 'N/A'}%</div>
                            <div class="analytics-label">Health Score</div>
                        </div>
                    </div>
                `;
                metricsContainer.innerHTML = metricsHTML;
            }

            // Utility methods
            formatBTC(satoshi) {
                return `₿${(Number(satoshi) / 100000000).toFixed(6)}`;
            }

            formatPercentage(basisPoints) {
                return `${(Number(basisPoints) / 100).toFixed(2)}%`;
            }

            formatCycles(cycles) {
                const trillion = 1_000_000_000_000;
                return `${(Number(cycles) / trillion).toFixed(1)}T`;
            }

            formatTimestamp(timestamp) {
                const date = new Date(Number(timestamp) / 1000000);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }

            getRiskClass(score) {
                if (score < 30) return 'risk-low';
                if (score < 70) return 'risk-medium';
                return 'risk-high';
            }

            getRiskLabel(score) {
                if (score < 30) return 'Low Risk';
                if (score < 70) return 'Medium Risk';
                return 'High Risk';
            }

            getSeverityClass(severity) {
                const severityKey = Object.keys(severity)[0];
                switch (severityKey) {
                    case 'Critical': return 'severity-critical';
                    case 'Error': return 'severity-error';
                    case 'Warning': return 'severity-warning';
                    case 'Info': return 'severity-info';
                    default: return 'severity-info';
                }
            }

            formatSeverity(severity) {
                return Object.keys(severity)[0];
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(229, 62, 62, 0.2);
                    color: #fc8181;
                    padding: 15px 20px;
                    border-radius: 10px;
                    border: 1px solid rgba(229, 62, 62, 0.3);
                    z-index: 1000;
                    max-width: 400px;
                `;
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 5000);
            }

            destroy() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }
        }

        // Global functions
        window.refreshDashboard = async () => {
            if (window.adminDashboard) {
                await window.adminDashboard.loadDashboard();
            }
        };

        window.openMaintenanceMode = () => {
            if (confirm('Are you sure you want to enable maintenance mode? This will temporarily disable user operations.')) {
                // Implementation for maintenance mode
                alert('Maintenance mode functionality would be implemented here');
            }
        };

        window.openAnalytics = () => {
            alert('Advanced analytics interface would be opened here');
        };

        // Initialize dashboard when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            window.adminDashboard = new AdminDashboardManager();
            await window.adminDashboard.init();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.adminDashboard) {
                window.adminDashboard.destroy();
            }
        });
    </script>
</body>
</html>
